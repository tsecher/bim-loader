BimLoaderObject=function(){function lastStop(e,t){e&&e.hasAttribute(self.PREFIX+"nb-loader")||(e=self.defaultOptions.parent),parentId=getParentId(e),window.clearTimeout(self.loaders[parentId].timer),t&&(console.log("BimLoader Error : ","Timeout"),isFunction(self.loaders[parentId].onTimeout)&&self.loaders[parentId].onTimeout.call(this,e,self.loaders[parentId])),setLoaderCount(e,0);var n=!1;isFunction(self.loaders[parentId].onStop)&&(n=self.loaders[parentId].onStop.call(this,e,self.loaders[parentId])),console.log("stopProcess",n),n||self.removeLoaderElements(e)}function getHTML(e){if(!e||!e.tagName)return"";var t=document.createElement("div");return t.appendChild(e),txt=t.innerHTML,t=null,txt}function getLoaderCount(e){return count=parseInt(e.getAttribute(self.PREFIX+"nb-loader")),isNaN(count)?0:count}function setLoaderCount(e,t){e.setAttribute(self.PREFIX+"nb-loader",t)}function getTemplateByPath(e,t){var n=[];if(e)for(var l in self.templates)(self.templates[l].path==e&&!t||t&&!self.templates[l].isLoading)&&(n[l]=self.templates[l]);return n}function getTemplateContent(e,t,n){var l=new XMLHttpRequest;l.onreadystatechange=function(){l.readyState==XMLHttpRequest.DONE&&(200==l.status?isFunction(t)&&t.call(this,l.responseText):isFunction(n)&&n.call(this,l.responseText))},l.open("GET",e,!0),l.send()}function isFunction(e){return"function"==typeof e}function getParentId(e){return e.hasAttribute(self.PREFIX+"id")?e.getAttribute(self.PREFIX+"id"):(pId="p_"+Math.round(1e5*Math.random()),e.setAttribute(self.PREFIX+"id",pId),pId)}function getContents(content){var data={},element=document.createElement("div");element.innerHTML=content;var script="",scripts=element.getElementsByTagName("script");for(var i in scripts)scripts[i].innerHTML&&(script+="\r\n//----\r\n"+scripts[i].innerHTML),isFunction(scripts[i].remove)&&scripts[i].remove();return templateOptions=null,script&&(eval(script),data.options=templateOptions),data.content=element.innerHTML,data}var self=this;self.templates={default:{content:"<div class='default-loader'><div>...</div></div>"}},self.loaders={},self.timeout=null,self.defaultTemplateName="default",self.defaultOptions={template:self.defaultTemplateName,timeout:1e4,parent:document.getElementsByTagName("body")[0],onStart:null,onDisplay:null,onStop:null,onRemove:null,onTimeout:null},self.PREFIX="data-bl-",self.setDefaultTemplate=function(e){self.loadTemplate(self.defaultTemplateName,e)},self.setDefaultTemplateContent=function(e){self.setTemplateContent(self.defaultTemplateName,e)},self.loadTemplate=function(e,t){self.templates[e]={name:e,isLoading:!0,path:t};var n=getTemplateByPath(t,!0);n[0]?self.templateName[e].content=n[0].content:getTemplateContent(t,function(e){getTemplateByPath(t,!1);for(var n in getTemplateByPath(t)){self.templates[n].isLoading=!1;var l=getContents(e);self.templates[n].content=l.content,self.templates[n].options=l.options}},function(n){console.log("BimLoader Error :","template "+e+" not found at "+t)})},self.start=function(e){var t={};for(var n in self.defaultOptions)t[n]=self.defaultOptions[n];var l=!1;if(e.template&&self.templates[e.template]&&self.templates[e.template].options?l=self.templates[e.template].options:self.templates[self.defaultOptions.template].options&&(l=self.templates[self.defaultOptions.template].options),l)for(var n in self.defaultOptions)t[n]=l[n]?l[n]:t[n];for(var n in self.defaultOptions)t[n]=e[n]?e[n]:t[n];if(e.parent||console.log("BimLoader Error :","No parent found, using default(<body>) instead"),self.templates[t.template]||(console.log("BimLoader Error :",'No template "'+t.template+'" found, using default instead'),t.template=self.defaultTemplateName),self.templates[t.template].isLoading&&(console.log("BimLoader Error :",'Template "'+t.template+'" is not loaded yet, using default instead'),t.template=self.defaultTemplateName),!isFunction(t.onStart)||!t.onStart.call(this,t.parent,t)){if(parentId=getParentId(t.parent),existingParent=self.loaders[parentId])window.clearTimeout(existingParent.timer);else{self.loaders[parentId]={};for(var n in t)self.loaders[parentId][n]=t[n];var a=document.createElement("div");for("object"==typeof self.templates[t.template].content?a.innerHTML=getHTML(self.templates[t.template].content):"<"==self.templates[t.template].content.trim()[0]?a.innerHTML=self.templates[t.template].content:a.innerHTML="<div>"+self.templates[t.template].content+"</div>";a.children.length>0;)a.children[0].setAttribute(self.PREFIX+"loader-element","true"),t.parent.appendChild(a.children[0]);a=null,isFunction(t.onDisplay)&&t.onDisplay.call(this,t.parent,t)}setLoaderCount(t.parent,getLoaderCount(t.parent)+1),self.loaders[parentId].timer=setTimeout(function(){lastStop(t.parent,!0)},t.timeout)}},self.stop=function(e){e&&e.hasAttribute(self.PREFIX+"nb-loader")||(e=self.defaultOptions.parent);var t=getParentId(e);self.loaders[t]&&(setLoaderCount(e,getLoaderCount(e)-1),0==getLoaderCount(e)&&lastStop(e))},self.removeLoaderElements=function(e){console.log("removeLoaderElements");var t=self.getLoaderElements(e);for(var n in t)t[n].remove();var l=getParentId(e);isFunction(self.loaders[l].onRemove)&&self.loaders[l].onRemove.call(this,e,self.loaders[l]),self.loaders[l]=null},self.getLoaderElements=function(e){for(var t=[],n=e.children.length-1;n>=0;n--)"true"==e.children[n].getAttribute(self.PREFIX+"loader-element")&&t.push(e.children[n]);return t},self.init=function(){document.dispatchEvent(new Event("BimLoaderReady"))},self.setDefaultOptions=function(e){for(var t in self.defaultOptions)self.defaultOptions[t]=e[t]?e[t]:self.defaultOptions[t]},self.setTemplateContent=function(e,t){self.templates[e]?self.templates[e].content=t:self.templates[e]={name:e,path:t,content:t}}},BimLoader=new BimLoaderObject,BimLoader.init();